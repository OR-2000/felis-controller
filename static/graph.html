<!DOCTYPE html>
<html>
  <head>
    <title>Locking vs Partition</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.7.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.0.0-beta.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@5.1.3"></script>
    <style media="print">
    .vega-embed { display: inline-block; }
    </style>
  </head>
  <body>
    <div>
      <div id="intro-v0"></div>
      <div id="intro-v1"></div>
      <div id="intro-v2"></div>
      <div id="intro-v3"></div>
    </div>
    <div>
      <h1>Without Dependency</h1>
      <div id="nodep-v0"></div>
      <div id="nodep-v1"></div>
      <div id="nodep-v2"></div>
      <div id="nodep-v3"></div>
      <h1>With Dependency</h1>
      <div id="dep-v0"></div>
      <!-- <div id="dep-v1"></div> -->
      <div id="dep-v2"></div>
      <!-- <div id="dep-v3"></div> -->
    </div>
    <div>
      <h1>Thresholds</h1>
      <div id="tune-v8"></div>
      <div id="tune-v9"></div>
      <div id="tune-v10"></div>
      <div id="tune-v11"></div>
      <h1>Epoch Size</h1>
      <div id="epoch-1"></div>
      <div id="epoch-2"></div>
    </div>
    <div>
      <h1>TPC-C</h1>
      <div id="eval-hotspot-tpcc1"></div>
      <div id="eval-hotspot-tpcc2"></div>
      <div id="eval-hotspot-tpcc3"></div>
      <div id="eval-hotspot-tpcc4"></div>
      <div id="eval-hotspot-tpcc5"></div>
    </div>
    <script type="text/javascript">
      let q = new URLSearchParams(location.search)
      let base = {
          'data': {'url': ''},
	  'width': 175,
	  'height': 120,
	  'layer': [
	      {
		  'mark': {
		      'type': 'errorbar',
		      'extent': 'ci',
		      'ticks': true,
		  },
		  'encoding': {
		      'x': {'field': 'cpu', 'type': 'quantitative', 'title': 'Cores', 'axis': {'grid': false}},
		      'y': {'field': 'throughput', 'type': 'quantitative', 'title': 'Throughput'},
		      'color': {'field': "symbol", 'type': "nominal", 'title': '', 'sort': ['Baseline',  'Serial Caracal', 'Granola', 'Parallel Caracal']}
		  }
	      },
	      {
		  'mark': {
		      'type': 'line',
		      'point': true,
		  },
		  'encoding': {
		      'x': {'field': 'cpu', 'type': 'quantitative', 'axis': {'values': [0, 8, 16, 24, 32]}},
		      'y': {'field': 'throughput', 'type': 'quantitative', 'aggregate': 'mean', 'axis': {'tickCount': 6, 'format': '~s'}, 'scale': {'domain': []}},
		      'color': {'field': "symbol", 'type': "nominal", 'title': '', 'sort': [ 'Baseline', 'Serial Caracal', 'Granola', 'Parallel Caracal']},
		  }
	      },
	  ],
	  'config': {
	      'range': {'category': []},
	      'view': {'stroke': 'transparent'},
	      'legend': {'offset': 2, 'labelOffset': 2, 'columns': 2, 'columnPadding': 2, 'orient': 'top'},
	  },
	  'transform': [
	      {},
	  ],
	  'padding': 0,
      };

      const plot = (title, filter, ydomain, selector) => {
	  let d = base
	  d['transform'][0] = {'filter': filter}
	  if (q.has('showTitle'))
	      d['title'] = title
	  d['layer'][1]['encoding']['y']['scale']['domain'] = ydomain
	  d['layer'][1]['encoding']['y']['axis']['values'] = [0, 1, 2, 3, 4, 5].map(x => x * ydomain[1] / 5)
	  vegaEmbed(selector, d, {'mode': 'vega-lite', 'renderer': 'svg'})
      }

      base['data']['url'] = 'ycsb.json'

      base['config']['range']['category'] = ['#640912', '#1f77b4']
      
      plot('LowContention NoSkew',
	   'datum.attribute == "cont0_noskew_nodep_locking" || datum.attribute == "cont0_noskew_nodep_granola"',
	   [0, 1500000],
	   '#intro-v0')

      plot('LowContention Skew',
	   'datum.attribute == "cont0_skew90_nodep_locking" || datum.attribute == "cont0_skew90_nodep_granola"',
	   [0, 1500000],
	   '#intro-v1')

      plot('Contention NoSkew',
  	   'datum.attribute == "cont7_noskew_nodep_locking" || datum.attribute == "cont7_noskew_nodep_granola"',
	   [0, 1500000],
	   '#intro-v2')

      plot('Contention Skew',
	   'datum.attribute == "cont7_skew90_nodep_locking" || datum.attribute == "cont7_skew90_nodep_granola"',
	   [0, 1500000],
	   '#intro-v3')

      base['config']['range']['category'] = ['#1f77b4', '#f6a7a8', '#640912', '#f54842',]
      plot('LowContention NoSkew',
	   'datum.attribute == "cont0_noskew_nodep_locking" || datum.attribute == "cont0_noskew_nodep_caracal-pieces" || datum.attribute == "cont0_noskew_nodep_caracal-serial" || datum.attribute == "cont0_noskew_nodep_granola"',
	   [0, 1500000],
	   '#nodep-v0')

      plot('LowContention Skew',
	   'datum.attribute == "cont0_skew90_nodep_locking" || datum.attribute == "cont0_skew90_nodep_caracal-pieces" || datum.attribute == "cont0_skew90_nodep_caracal-serial" || datum.attribute == "cont0_skew90_nodep_granola"',
	   [0, 1500000],
	   '#nodep-v1')

      plot('High Contention NoSkew',
	   'datum.attribute == "cont7_noskew_nodep_locking" || datum.attribute == "cont7_noskew_nodep_caracal-pieces" || datum.attribute == "cont7_noskew_nodep_caracal-serial" || datum.attribute == "cont7_noskew_nodep_granola"',
	   [0, 1500000],
	   '#nodep-v2')

      plot('High Contention Skew',
	   'datum.attribute == "cont7_skew90_nodep_locking" || datum.attribute == "cont7_skew90_nodep_caracal-pieces" || datum.attribute == "cont7_skew90_nodep_caracal-serial" || datum.attribute == "cont7_skew90_nodep_granola"',
	   [0, 1500000],
	   '#nodep-v3')


      base['config']['range']['category'] = ['#640912', '#f54842']
      plot('Low Contention NoSkew',
	   'datum.attribute == "cont0_noskew_dep_caracal-pieces" || datum.attribute == "cont0_noskew_dep_granola"',
	   [0, 1500000],
	   '#dep-v0')
/*
      plot('Low Contention Skew',
	   'datum.attribute == "cont0_skew90_dep_caracal-pieces" || datum.attribute == "cont0_skew90_dep_granola"',
	   [0, 2000000],
	   '#dep-v1')
*/
      plot('High Contention NoSkew',
	   'datum.attribute == "cont7_noskew_dep_caracal-pieces" || datum.attribute == "cont7_noskew_dep_granola"',
	   [0, 1500000],
	   '#dep-v2')
/*
      plot('High Contention Skew',
	   'datum.attribute == "cont7_skew90_dep_caracal-pieces" || datum.attribute == "cont7_skew90_dep_granola"',
	   [0, 800000],
	   '#dep-v3')
*/
      base['data']['url'] = 'hotspot-tpcc.json'
      base['config']['range']['category'] = ['#640912', '#f6a7a8']

      plot('LowSkew TPC-C',
	   'datum.attribute == "hotspot000_caracal" || datum.attribute == "hotspot000_granola"',
	   [0, 1200000],
	   '#eval-hotspot-tpcc1')

      plot('Skew (2x) TPC-C',
	   'datum.attribute == "hotspot200_caracal" || datum.attribute == "hotspot200_granola"',
	   [0, 1200000],
	   '#eval-hotspot-tpcc2')

      plot('Skew (3x) TPC-C',
	   'datum.attribute == "hotspot300_caracal" || datum.attribute == "hotspot300_granola"',
	   [0, 1200000],
	   '#eval-hotspot-tpcc3')


      plot('Skew (4x) TPC-C',
	   'datum.attribute == "hotspot400_caracal" || datum.attribute == "hotspot400_granola"',
	   [0, 1200000],
	   '#eval-hotspot-tpcc4')


      base['data']['url'] = 'ycsb.json'
      for (let i = 0; i < 2; i++)
	  base['layer'][i]['encoding']['x']['field'] = 'threshold'

      for (let i = 0; i < 2; i++)
	  base['layer'][i]['encoding']['x']['title'] = 'Threshold (%)'

      base['layer'][1]['encoding']['x']['axis'] = {}

      base['config']['range']['category'] = ['#f54842']

      plot('On Demand Splitting Threshold',
	   'datum.threshold && test(/noskew_dep_caracal-pieces/, datum.attribute)',
	   [0, 1500000],
	   '#tune-v8')

      plot('On Demand Splitting Threshold',
	   'datum.threshold && test(/skew90_dep_caracal-pieces/, datum.attribute)',
	   [0, 1500000],
	   '#tune-v9')

      base['config']['range']['category'] = ['#f6a7a8']

      plot('Core Scaling Threshold',
	   'datum.threshold && test(/noskew_dep_caracal-serial/, datum.attribute)',
	   [0, 1500000],
	   '#tune-v10')

      plot('Core Scaling Threshold',
	   'datum.threshold && test(/skew90_dep_caracal-serial/, datum.attribute)',
	   [0, 1500000],
	   '#tune-v11')

      for (let i = 0; i < 2; i++)
	  base['layer'][i]['encoding']['x']['field'] = 'latency'

      for (let i = 0; i < 2; i++)
	  base['layer'][i]['encoding']['x']['title'] = 'Latency (ms)'
      base['config']['range']['category'] = ['#57a0ff', '#f54842']
      base['transform'][1] = {calculate: 'test(/skew/, datum.attribute) ? (test(/skew90/, datum.attribute) ? "YCSB Skew" : "YCSB Uniform") : "TPC-C"', as: 'symbol'}
      plot('Epoch YCSB',
	   'datum.latency',
	   [0, 1500000],
	   '#epoch-1')

      base['data']['url'] = 'hotspot-tpcc.json'
      
      plot('Epoch TPC-C',
	   'datum.latency',
	   [0, 1200000],
	   '#epoch-2')

    </script>
  </body>
</html>
